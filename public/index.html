<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Greecing Real Estate</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--navy:#02045E;--navy-mid:#0d1066;--bg:#f4f2ed;--bg-card:#fff;--bg-input:#eeebe4;--gold:#c49a2c;--gold-soft:rgba(196,154,44,.1);--green:#1a9a5a;--green-soft:rgba(26,154,90,.08);--blue:#2a6bc4;--blue-soft:rgba(42,107,196,.08);--red:#c44230;--red-soft:rgba(196,66,48,.08);--amber:#c48a20;--amber-soft:rgba(196,138,32,.08);--text:#1a1a2e;--text-sec:#4a4e5c;--text-dim:#8a8e9c;--border:rgba(2,4,94,.07);--r:12px;--font:'Plus Jakarta Sans',-apple-system,sans-serif;--sh:0 1px 3px rgba(0,0,0,.05)}
*{margin:0;padding:0;box-sizing:border-box}body{font-family:var(--font);background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;overflow-x:hidden}.app{max-width:430px;margin:0 auto;min-height:100vh}
.header{position:sticky;top:0;z-index:50;background:var(--navy);padding:14px 16px 12px;box-shadow:0 4px 20px rgba(2,4,94,.3)}
.header-row{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.logo-svg{height:20px;flex-shrink:0}.brand-tag{font-size:9px;color:rgba(255,255,255,.4);font-weight:700;letter-spacing:1.5px;text-transform:uppercase;margin-left:auto}
.stats-row{display:flex;gap:5px}.mini-stat{flex:1;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.06);border-radius:8px;padding:7px 4px;text-align:center}.mini-stat-val{font-size:14px;font-weight:800;color:#fff;transition:transform .2s}.mini-stat-lbl{font-size:7.5px;color:rgba(255,255,255,.4);font-weight:700;text-transform:uppercase;letter-spacing:.3px}.mini-stat-val.gold{color:var(--gold)}
.filters-section{padding:10px 16px 8px;background:var(--bg-card);position:sticky;top:88px;z-index:40;border-bottom:1px solid var(--border);box-shadow:var(--sh)}
.filter-row{display:flex;gap:5px;margin-bottom:5px}.filter-select{flex:1;position:relative}
.filter-select select{width:100%;appearance:none;-webkit-appearance:none;padding:8px 24px 8px 9px;background:var(--bg-input);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--font);font-size:11.5px;font-weight:600;cursor:pointer;outline:none}
.filter-select select:focus{border-color:var(--navy)}.filter-select select:disabled{opacity:.35;cursor:not-allowed}
.filter-select::after{content:'\u25BE';position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:8px;color:var(--text-dim);pointer-events:none}
.filter-bottom{display:flex;gap:5px;align-items:center}
.filter-input{flex:1;padding:7px 9px;background:var(--bg-input);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--font);font-size:11.5px;font-weight:500;outline:none}.filter-input:focus{border-color:var(--navy)}.filter-input::placeholder{color:var(--text-dim)}
.filter-sep{color:var(--text-dim);font-size:10px;font-weight:600;flex-shrink:0}
.btn-search{padding:7px 12px;background:var(--navy);color:#fff;border:none;border-radius:8px;font-family:var(--font);font-size:12px;font-weight:700;cursor:pointer;flex-shrink:0}.btn-search:active{transform:scale(.95)}
.btn-reset{padding:7px 9px;background:transparent;color:var(--text-dim);border:1px solid var(--border);border-radius:8px;font-family:var(--font);font-size:10px;font-weight:600;cursor:pointer;flex-shrink:0}
.active-filters{display:flex;flex-wrap:wrap;gap:4px;margin-top:5px}.active-tag{display:inline-flex;align-items:center;gap:3px;padding:3px 8px;background:rgba(2,4,94,.06);border:1px solid rgba(2,4,94,.1);border-radius:5px;font-size:10px;font-weight:600;color:var(--navy)}.active-tag .x{cursor:pointer;font-size:9px;opacity:.5}
.results{padding:8px 16px 100px}.results-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}.results-count{font-size:12px;color:var(--text-dim);font-weight:600}
.sort-select{appearance:none;-webkit-appearance:none;padding:5px 22px 5px 8px;background:var(--bg-card) url("data:image/svg+xml,%3Csvg width='8' height='5' viewBox='0 0 8 5' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L4 4L7 1' stroke='%238a8e9c' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E") no-repeat right 8px center;border:1px solid var(--border);border-radius:7px;color:var(--text-sec);font-family:var(--font);font-size:10px;font-weight:600;outline:none;cursor:pointer}
.loading{text-align:center;padding:60px 20px}.spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--navy);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 12px}@keyframes spin{to{transform:rotate(360deg)}}.loading-text{font-size:13px;color:var(--text-dim);font-weight:600}
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r);padding:13px;margin-bottom:7px;cursor:pointer;transition:all .15s;box-shadow:var(--sh)}.card:active{transform:scale(.985)}
.card-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:5px}.card-badges{display:flex;gap:4px;flex-wrap:wrap}
.badge{padding:2px 6px;border-radius:4px;font-size:9.5px;font-weight:700}.badge-sale{background:var(--red-soft);color:var(--red)}.badge-rent{background:var(--blue-soft);color:var(--blue)}.badge-new{background:var(--green-soft);color:var(--green)}.badge-drop{background:var(--green-soft);color:var(--green)}.badge-up{background:var(--amber-soft);color:var(--amber)}.badge-mod{background:rgba(0,0,0,.03);color:var(--text-dim)}
.card-type{font-size:10px;color:var(--text-dim);font-weight:600}.card-price{font-size:21px;font-weight:800;letter-spacing:-.5px;line-height:1.2;color:var(--navy)}
.card-change{display:inline-flex;align-items:center;gap:3px;font-size:10px;font-weight:700;margin-top:2px;padding:2px 5px;border-radius:4px}.change-down{background:var(--green-soft);color:var(--green)}.change-up{background:var(--amber-soft);color:var(--amber)}
.card-meta{display:flex;gap:8px;margin:6px 0;font-size:11px;color:var(--text-sec);font-weight:500}.card-meta span{display:flex;align-items:center;gap:2px}
.card-location{font-size:11px;color:var(--text-sec);font-weight:500;margin-bottom:5px}
.card-features{display:flex;flex-wrap:wrap;gap:3px;margin-bottom:7px}.feat{padding:2px 5px;background:var(--bg-input);border-radius:4px;font-size:9px;color:var(--text-dim);font-weight:600}
.card-dates{display:flex;gap:10px;padding-top:7px;border-top:1px solid var(--border);font-size:9.5px;color:var(--text-dim);font-weight:500;font-style:italic}
.overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(2,4,94,.35);z-index:200;display:none;justify-content:center;align-items:flex-end;backdrop-filter:blur(3px)}.overlay.open{display:flex}
.sheet{width:100%;max-width:430px;max-height:88vh;background:var(--bg-card);border-top-left-radius:20px;border-top-right-radius:20px;overflow-y:auto;animation:su .3s cubic-bezier(.32,.72,0,1)}@keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}
.sheet-handle{width:32px;height:4px;background:var(--text-dim);border-radius:2px;margin:8px auto 12px;opacity:.25}
.sheet-header{display:flex;justify-content:space-between;align-items:center;padding:0 18px 12px;border-bottom:1px solid var(--border)}
.sheet-close{width:28px;height:28px;background:var(--bg-input);border:none;border-radius:8px;color:var(--text-dim);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.sheet-body{padding:14px 18px 32px}
.detail-hero{background:linear-gradient(135deg,var(--navy),var(--navy-mid));border-radius:var(--r);padding:18px;text-align:center;margin-bottom:12px;color:#fff}
.detail-price{font-size:28px;font-weight:800;letter-spacing:-1px}.detail-sub{font-size:12px;color:rgba(255,255,255,.5);font-weight:600;margin-top:3px}
.detail-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;margin-bottom:12px}.detail-cell{background:var(--bg-input);border-radius:10px;padding:10px 6px;text-align:center}.detail-cell-val{font-size:16px;font-weight:700;color:var(--navy)}.detail-cell-lbl{font-size:8px;color:var(--text-dim);font-weight:700;text-transform:uppercase}
.detail-section{margin-top:12px}.detail-section-title{font-size:10px;font-weight:700;color:var(--text-dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.detail-feat-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px}.detail-feat{display:flex;align-items:center;gap:5px;padding:7px 9px;background:var(--bg-input);border-radius:7px;font-size:11px;font-weight:500;color:var(--text-dim)}.detail-feat.yes{color:var(--green);background:var(--green-soft)}
.detail-dates{margin-top:12px;padding:10px;background:var(--bg-input);border-radius:9px;font-size:10px;color:var(--text-dim);font-weight:500;line-height:1.9}
.btn-link{display:block;width:100%;padding:13px;background:var(--navy);color:#fff;border:none;border-radius:11px;font-family:var(--font);font-size:13px;font-weight:700;cursor:pointer;margin-top:14px;text-align:center;text-decoration:none}
.empty{text-align:center;padding:48px 20px;color:var(--text-dim)}.empty-icon{font-size:36px;margin-bottom:8px}.empty-text{font-size:12px;font-weight:600}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="header-row">
      <svg class="logo-svg" viewBox="0 0 300 65.613" xmlns="http://www.w3.org/2000/svg"><g><path fill="#fff" d="M17.284,65.613c-5.784,0-12.564-1.861-17.019-5.186l5.452-7.778c3.191,2.793,7.246,4.189,10.968,4.189c6.382,0,9.374-3.724,9.374-9.24v-1.995H25.86c-2.061,2.659-5.65,4.388-10.038,4.388C5.784,49.991,0,42.146,0,32.973c0-9.174,5.784-17.351,15.755-17.351c4.122,0,8.244,1.662,10.57,5.185h0.133v-4.254h10.304v29.981C36.762,59.497,29.051,65.613,17.284,65.613z M18.348,24.53c-4.919,0-7.778,3.789-7.778,8.376c0,4.387,2.858,8.443,7.778,8.443c4.986,0,8.044-3.923,8.044-8.443S23.268,24.53,18.348,24.53z"/><path fill="#fff" d="M66.875,25.46c-.998-.266-1.928-.332-2.792-.332c-5.85,0-7.778,4.786-7.778,7.512v17.018H45.402V16.553h10.503v4.787h.133c1.662-3.325,4.919-5.717,8.975-5.717c.864,0,1.795.066,2.327.266L66.875,25.46z"/><path fill="#fff" d="M103.304,36.097H79.305c.333,3.656,3.989,6.249,7.911,6.249c3.457,0,5.85-1.462,7.313-3.456l7.578,4.785c-3.124,4.521-8.31,7.048-15.024,7.048c-9.972,0-18.215-6.315-18.215-17.484c0-10.835,7.845-17.749,17.882-17.749c9.772,0,16.62,6.714,16.62,18.015C103.371,34.369,103.371,35.3,103.304,36.097z M93.332,29.316c0-3.457-2.193-6.315-6.515-6.315c-4.188,0-7.246,2.925-7.512,6.315H93.332z"/><path fill="#fff" d="M142.922,36.097h-23.999c.333,3.656,3.989,6.249,7.911,6.249c3.457,0,5.851-1.462,7.313-3.456l7.579,4.785c-3.124,4.521-8.31,7.048-15.024,7.048c-9.972,0-18.215-6.315-18.215-17.484c0-10.835,7.845-17.749,17.882-17.749c9.772,0,16.62,6.714,16.62,18.015C142.989,34.369,142.989,35.3,142.922,36.097z M132.951,29.316c0-3.457-2.194-6.315-6.515-6.315c-4.188,0-7.246,2.925-7.513,6.315H132.951z"/><path fill="#fff" d="M172.569,27.256c-1.196-1.596-3.59-2.659-5.784-2.659c-4.587,0-7.645,3.922-7.645,8.509s2.992,8.442,7.778,8.442c2.193,0,4.587-.864,5.916-2.459l6.049,7.379c-2.725,2.658-7.378,4.255-12.231,4.255c-10.437,0-18.547-6.647-18.547-17.617c0-10.769,8.177-17.616,18.48-17.616c4.72,0,9.706,1.794,12.298,4.454L172.569,27.256z"/><path fill="#fff" d="M188.789,11.966c-3.524,0-6.249-2.726-6.249-5.983c0-3.191,2.725-5.983,6.249-5.983c3.456,0,6.249,2.659,6.249,5.983C195.038,9.373,192.245,11.966,188.789,11.966z M183.338,49.658V16.553h10.901v33.105H183.338z"/><path fill="#fff" d="M224.619,49.658V31.576c0-3.656-.998-6.979-4.92-6.979c-3.855,0-5.85,3.324-5.85,7.112v17.949h-10.969V16.553h10.569v4.587h.134c1.528-2.925,5.318-5.518,9.904-5.518c8.909,0,12.1,6.914,12.1,13.562v20.475H224.619z"/><path fill="#fff" d="M259.45,65.613c-5.783,0-12.563-1.861-17.018-5.186l5.451-7.778c3.19,2.793,7.246,4.189,10.969,4.189c6.382,0,9.373-3.724,9.373-9.24v-1.995h-.199c-2.061,2.659-5.65,4.388-10.038,4.388c-10.038,0-15.821-7.845-15.821-17.019c0-9.174,5.783-17.351,15.755-17.351c4.121,0,8.243,1.662,10.57,5.185h.133v-4.254h10.304v29.981C278.929,59.497,271.218,65.613,259.45,65.613z M260.515,24.53c-4.919,0-7.778,3.789-7.778,8.376c0,4.387,2.859,8.443,7.778,8.443c4.985,0,8.043-3.923,8.043-8.443S265.434,24.53,260.515,24.53z"/><path fill="#fff" d="M293.353,50.324c-3.656,0-6.78-2.793-6.78-6.449c0-3.59,3.057-6.582,6.78-6.582c3.59,0,6.647,2.859,6.647,6.516S296.942,50.324,293.353,50.324z"/></g></svg>
      <span class="brand-tag">Real Estate</span>
    </div>
    <div class="stats-row">
      <div class="mini-stat"><div class="mini-stat-val" id="sTotal">â</div><div class="mini-stat-lbl">ÎÎ³Î³ÎµÎ»Î¯ÎµÏ</div></div>
      <div class="mini-stat"><div class="mini-stat-val gold" id="sNew">â</div><div class="mini-stat-lbl">ÎÎ­ÎµÏ 24Ï</div></div>
      <div class="mini-stat"><div class="mini-stat-val" id="sDrops" style="color:#ff6b6b">â</div><div class="mini-stat-lbl">ÎÎµÎ¹ÏÏÎµÎ¹Ï</div></div>
      <div class="mini-stat"><div class="mini-stat-val gold" id="sAvg">â</div><div class="mini-stat-lbl">ÎÎ­ÏÎ¿ â¬/ÏÎ¼</div></div>
    </div>
  </div>
  <div class="filters-section">
    <div class="filter-row">
      <div class="filter-select"><select id="fCat" onchange="apply()"><option value="">ÎÎ±ÏÎ·Î³Î¿ÏÎ¯Î±</option><option value="res">ð  ÎÎ±ÏÎ¿Î¹ÎºÎ¯Î±</option><option value="com">ð¢ ÎÏÎ±Î³Î³ÎµÎ»Î¼Î±ÏÎ¹ÎºÏ</option></select></div>
      <div class="filter-select"><select id="fTrans" onchange="apply()"><option value="">Î£ÏÎ½Î±Î»Î»Î±Î³Î®</option><option value="Î ÏÎ»Î·ÏÎ·">Î ÏÎ»Î·ÏÎ·</option><option value="ÎÎ½Î¿Î¹ÎºÎ¯Î±ÏÎ·">ÎÎ½Î¿Î¹ÎºÎ¯Î±ÏÎ·</option></select></div>
    </div>
    <div class="filter-row">
      <div class="filter-select"><select id="fSec" onchange="onSec()"><option value="">Î¤Î¿Î¼Î­Î±Ï</option><option value="north">ÎÏÏÎµÎ¹Î± Î ÏÎ¿Î¬ÏÏÎ¹Î±</option><option value="south">ÎÏÏÎ¹Î± Î ÏÎ¿Î¬ÏÏÎ¹Î±</option><option value="east">ÎÎ½Î±ÏÎ¿Î»Î¹ÎºÎ¬ Î ÏÎ¿Î¬ÏÏÎ¹Î±</option><option value="west">ÎÏÏÎ¹ÎºÎ¬ Î ÏÎ¿Î¬ÏÏÎ¹Î±</option><option value="center">ÎÎ­Î½ÏÏÎ¿ ÎÎ¸Î®Î½Î±Ï</option><option value="piraeus">Î ÎµÎ¹ÏÎ±Î¹Î¬Ï</option></select></div>
      <div class="filter-select"><select id="fArea" onchange="apply()" disabled><option value="">Î ÎµÏÎ¹Î¿ÏÎ®</option></select></div>
    </div>
    <div class="filter-bottom">
      <input type="number" class="filter-input" id="fPMin" placeholder="Î¤Î¹Î¼Î® Î±ÏÏ" onchange="apply()">
      <span class="filter-sep">â</span>
      <input type="number" class="filter-input" id="fPMax" placeholder="Î¤Î¹Î¼Î® Î­ÏÏ" onchange="apply()">
      <button class="btn-search" onclick="apply()">ð</button>
      <button class="btn-reset" onclick="resetAll()">â</button>
    </div>
    <div class="active-filters" id="tags"></div>
  </div>
  <div class="results">
    <div class="results-header">
      <div class="results-count" id="rCount">â</div>
      <select class="sort-select" id="sortBy" onchange="apply()"><option value="newest">Î Î¹Î¿ ÏÏÏÏÏÎ±ÏÎ±</option><option value="price_asc">Î¤Î¹Î¼Î® â</option><option value="price_desc">Î¤Î¹Î¼Î® â</option><option value="sqm_desc">ÎÎ¼Î²Î±Î´ÏÎ½ â</option><option value="ppsqm_asc">â¬/ÏÎ¼ â</option></select>
    </div>
    <div id="list"></div>
  </div>
</div>
<div class="overlay" id="overlay" onclick="if(event.target===this)closeDetail()"><div class="sheet" id="sheet"></div></div>
<script>
// âââ TELEGRAM WEBAPP INIT âââ
if(window.Telegram&&window.Telegram.WebApp){
  const tg=window.Telegram.WebApp;
  tg.ready();
  tg.expand();
  tg.headerColor='#02045E';
  tg.backgroundColor='#f4f2ed';
}

// âââ CONFIG âââ
const SB_URL='https://ewubsvzjxvwkwtvlrfek.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV3dWJzdnpqeHZ3a3d0dmxyZmVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2MzEzOTAsImV4cCI6MjA4NjIwNzM5MH0.k8FCmt83axmrQaR6fiKChDFDFkP--Z9qHMF-DZkCYBs';
const TBL='listings';

// âââ SECTORS âââ
const SEC={
  north:{l:'ÎÏÏÎµÎ¹Î± Î ÏÎ¿Î¬ÏÏÎ¹Î±',a:['ÎÎ³Î¯Î± Î Î±ÏÎ±ÏÎºÎµÏÎ®','ÎÎ³Î¹Î¿Ï Î£ÏÎ­ÏÎ±Î½Î¿Ï','ÎÏÎ¹Î»Î®ÏÏÎ¹Î±','ÎÎ­ÏÎ±ÎºÎ±Ï','ÎÎ¹ÏÎ½ÏÏÎ¿Ï','ÎÏÎ¿ÏÎ¹Î¬','ÎÎºÎ¬Î»Î·','ÎÎ·ÏÎ¹ÏÎ¹Î¬','ÎÏÎºÏÎ²ÏÏÏÎ·','ÎÎ±ÏÎ¿ÏÏÎ¹','ÎÎµÎ»Î¯ÏÏÎ¹Î±','ÎÎ­Î± ÎÏÏÎ¸ÏÎ±Î¯Î±','ÎÎ­Î± Î ÎµÎ½ÏÎ­Î»Î·','ÎÎ­Î¿ Î¨ÏÏÎ¹ÎºÏ','Î Î±Î»Î»Î®Î½Î·','Î ÎµÏÎºÎ·','Î Î¿Î»ÏÎ´ÏÎ¿ÏÎ¿','Î ÏÎ¬ÏÎ¹Î½Î¿Ï ÎÏÏÎ¿Ï','Î£ÏÎ±Î¼Î¬ÏÎ±','Î¦Î¹Î»Î¿Î¸Î­Î·','Î§Î±Î»Î¬Î½Î´ÏÎ¹','Î§Î¿Î»Î±ÏÎ³ÏÏ','Î¨ÏÏÎ¹ÎºÏ']},
  south:{l:'ÎÏÏÎ¹Î± Î ÏÎ¿Î¬ÏÏÎ¹Î±',a:['ÎÎ³Î¹Î¿Ï ÎÎ·Î¼Î®ÏÏÎ¹Î¿Ï','ÎÎ»Î¹Î¼Î¿Ï','ÎÏÎ³ÏÏÎ¿ÏÏÎ¿Î»Î·','ÎÎ¬ÏÎ·','ÎÎ¿ÏÎ»Î±','ÎÎ¿ÏÎ»Î¹Î±Î³Î¼Î­Î½Î·','ÎÎ»ÏÏÎ¬Î´Î±','ÎÎ»Î»Î·Î½Î¹ÎºÏ','ÎÎ»Î¹Î¿ÏÏÎ¿Î»Î·','ÎÎ±Î»Î»Î¹Î¸Î­Î±','ÎÎ­Î± Î£Î¼ÏÏÎ½Î·','Î Î±Î»Î±Î¹Ï Î¦Î¬Î»Î·ÏÎ¿']},
  east:{l:'ÎÎ½Î±ÏÎ¿Î»Î¹ÎºÎ¬ Î ÏÎ¿Î¬ÏÏÎ¹Î±',a:['ÎÏÏÎ­Î¼Î¹Î´Î±','ÎÎ»ÏÎºÎ¬ ÎÎµÏÎ¬','ÎÎ¿ÏÏÏÎ¯','ÎÎ±ÏÎºÏÏÎ¿ÏÎ»Î¿','ÎÎ­Î± ÎÎ¬ÎºÏÎ·','Î Î±Î¹Î±Î½Î¯Î±','Î¡Î±ÏÎ®Î½Î±','Î£ÏÎ¬ÏÎ±']},
  west:{l:'ÎÏÏÎ¹ÎºÎ¬ Î ÏÎ¿Î¬ÏÏÎ¹Î±',a:['ÎÎ³. ÎÎ½Î¬ÏÎ³ÏÏÎ¿Î¹','ÎÎ¹Î³Î¬Î»ÎµÏ','ÎÎ»Î¹Î¿Î½','ÎÎ±Î¼Î±ÏÎµÏÏ','Î ÎµÏÏÎ¿ÏÏÎ¿Î»Î·','Î ÎµÏÎ¹ÏÏÎ­ÏÎ¹','Î§Î±ÏÎ´Î¬ÏÎ¹']},
  center:{l:'ÎÎ­Î½ÏÏÎ¿ ÎÎ¸Î®Î½Î±Ï',a:['ÎÎ³Î¹Î¿Ï ÎÎ»ÎµÏÎ¸Î­ÏÎ¹Î¿Ï','ÎÎ¸Î®Î½Î± - ÎÎ­Î½ÏÏÎ¿','ÎÎ¼ÏÎµÎ»ÏÎºÎ·ÏÎ¿Î¹','ÎÎºÎ¬Î¶Î¹','ÎÎ¿ÏÎ´Î®','ÎÎ¾Î¬ÏÏÎµÎ¹Î±','ÎÏÎ³ÏÎ¬ÏÎ¿Ï','ÎÎ»Î¯ÏÎ¹Î±','ÎÎ¿Î»ÏÎ½Î¬ÎºÎ¹','ÎÎ¿Î»ÏÎ½ÏÏ','ÎÎ¿ÏÎºÎ¬ÎºÎ¹','ÎÏÏÎ­Î»Î·','ÎÎµÏÏ','ÎÎ¿Î½Î±ÏÏÎ·ÏÎ¬ÎºÎ¹','ÎÎ­Î¿Ï ÎÏÏÎ¼Î¿Ï','Î Î±Î³ÎºÏÎ¬ÏÎ¹','Î Î±ÏÎ®ÏÎ¹Î±','Î ÎµÏÏÎ¬Î»ÏÎ½Î±','Î Î»Î¬ÎºÎ±','Î Î»Î±ÏÎµÎ¯Î± ÎÏÏÎ¹ÎºÎ®Ï','ÎÎ·ÏÎµÎ¯Î¿']},
  piraeus:{l:'Î ÎµÎ¹ÏÎ±Î¹Î¬Ï',a:['ÎÎ³Î¯Î± Î¤ÏÎ¹Î¬Î´Î±','ÎÏÎ±ÏÎµÏÏÏÎ½Î±','ÎÏÎµÎ¹ÏÏÏÎ¹ÎºÎ±','ÎÎ±Î»Î»Î¯ÏÎ¿Î»Î·','ÎÎ±ÏÏÎ­Î»Î»Î±','ÎÎ­Î½ÏÏÎ¿','ÎÎµÏÎ±ÏÏÎ¯Î½Î¹','ÎÎ¿ÏÏÎ¬ÏÎ¿','ÎÎ¯ÎºÎ±Î¹Î±','Î Î±ÏÎ±Î»Î¹Î¼Î¬Î½Î¹','Î ÎµÎ¹ÏÎ±Î¹Î¬Ï','Î¦ÏÎµÎ±ÏÏÏÎ´Î±']}
};
const RES=['ÎÎ¹Î±Î¼Î­ÏÎ¹ÏÎ¼Î±','ÎÎ¿Î½Î¿ÎºÎ±ÏÎ¿Î¹ÎºÎ¯Î±','ÎÎµÎ¶Î¿Î½Î­ÏÎ±','ÎÎºÎ±ÏÏÎ¿Î½Î¹Î­ÏÎ±','Î¿Î¹ÎºÎ¯Î±','ÎÎ¯Î»Î±'];
const COM=['ÎÏÎ±ÏÎµÎ¯Î¿','ÎÎ±ÏÎ¬ÏÏÎ·Î¼Î±'];
const EM={'ÎÎ¹Î±Î¼Î­ÏÎ¹ÏÎ¼Î±':'ð¢','ÎÎ¿Î½Î¿ÎºÎ±ÏÎ¿Î¹ÎºÎ¯Î±':'ð¡','ÎÎµÎ¶Î¿Î½Î­ÏÎ±':'ðï¸','ÎÏÎ±ÏÎµÎ¯Î¿':'ð¢','ÎÎ±ÏÎ¬ÏÏÎ·Î¼Î±':'ðª','ÎÎºÎ±ÏÏÎ¿Î½Î¹Î­ÏÎ±':'ð ','Î¿Î¹ÎºÎ¯Î±':'ð¡'};

let ALL=[],FILT=[];

// âââ FETCH âââ
async function load(){
  document.getElementById('list').innerHTML='<div class="loading"><div class="spinner"></div><div class="loading-text">Î¦ÏÏÏÏÏÎ· Î±Î³Î³ÎµÎ»Î¹ÏÎ½...</div></div>';
  try{
    const r=await fetch(`${SB_URL}/rest/v1/${TBL}?select=*&order=last_seen_date.desc&limit=2000`,{headers:{'apikey':SB_KEY,'Authorization':`Bearer ${SB_KEY}`}});
    if(!r.ok)throw new Error('HTTP '+r.status);
    ALL=await r.json();
    apply();
  }catch(e){document.getElementById('list').innerHTML=`<div class="empty"><div class="empty-icon">â ï¸</div><div class="empty-text">Î£ÏÎ¬Î»Î¼Î±: ${e.message}</div></div>`;}
}

// âââ HELPERS âââ
const fmt=n=>n!=null?new Intl.NumberFormat('el-GR').format(Math.round(n))+'â¬':'N/A';
const fmtK=n=>n>=1e6?(n/1e6).toFixed(1)+'Mâ¬':n>=1000?Math.round(n/1000)+'kâ¬':fmt(n);
function timeAgo(ds){if(!ds)return'';const d=new Date(ds),now=new Date(),df=now-d,m=Math.floor(df/6e4),h=Math.floor(df/36e5),dy=Math.floor(df/864e5);if(m<60)return m+' Î»ÎµÏÏÎ¬ ÏÏÎ¹Î½';if(h<24)return h+(h===1?' ÏÏÎ± ÏÏÎ¹Î½':' ÏÏÎµÏ ÏÏÎ¹Î½');if(dy===1)return'ÏÎ¸ÎµÏ';if(dy<7)return dy+' Î·Î¼Î­ÏÎµÏ ÏÏÎ¹Î½';return d.toLocaleDateString('el-GR',{day:'numeric',month:'short'});}
function fmtDate(ds){if(!ds)return'â';return new Date(ds).toLocaleDateString('el-GR',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'});}

// âââ SECTOR CASCADE âââ
function onSec(){
  const s=document.getElementById('fSec').value,a=document.getElementById('fArea');
  a.innerHTML='<option value="">Î ÎµÏÎ¹Î¿ÏÎ®</option>';
  if(s&&SEC[s]){a.disabled=false;SEC[s].a.forEach(x=>{const o=document.createElement('option');o.value=x;o.textContent=x;a.appendChild(o);})}
  else{a.disabled=true;}
  apply();
}

// âââ APPLY FILTERS + DYNAMIC STATS âââ
function apply(){
  let r=[...ALL];
  const cat=document.getElementById('fCat').value;
  const trans=document.getElementById('fTrans').value;
  const sec=document.getElementById('fSec').value;
  const area=document.getElementById('fArea').value;
  const pMin=parseInt(document.getElementById('fPMin').value);
  const pMax=parseInt(document.getElementById('fPMax').value);
  const sort=document.getElementById('sortBy').value;

  if(cat==='res')r=r.filter(l=>RES.includes(l.property_type));
  if(cat==='com')r=r.filter(l=>COM.includes(l.property_type));
  if(trans)r=r.filter(l=>l.transaction_type===trans);
  if(area)r=r.filter(l=>l.area===area);
  else if(sec&&SEC[sec])r=r.filter(l=>SEC[sec].a.includes(l.area)||(sec==='piraeus'&&l.city==='Î ÎµÎ¹ÏÎ±Î¹Î¬Ï'));
  if(!isNaN(pMin))r=r.filter(l=>l.price>=pMin);
  if(!isNaN(pMax))r=r.filter(l=>l.price<=pMax);

  switch(sort){
    case'newest':r.sort((a,b)=>(b.last_seen_date||'').localeCompare(a.last_seen_date||''));break;
    case'price_asc':r.sort((a,b)=>(a.price||0)-(b.price||0));break;
    case'price_desc':r.sort((a,b)=>(b.price||0)-(a.price||0));break;
    case'sqm_desc':r.sort((a,b)=>(b.square_meters||0)-(a.square_meters||0));break;
    case'ppsqm_asc':r.sort((a,b)=>(a.price_per_sqm||99999)-(b.price_per_sqm||99999));break;
  }
  FILT=r;
  // âââ DYNAMIC STATS (reflect filtered results) âââ
  const h24=new Date(Date.now()-864e5).toISOString();
  const n24=r.filter(l=>(l.first_seen_date||l.last_seen_date||'')>=h24).length;
  const drops=r.filter(l=>l.price_change&&l.price_change<0).length;
  const wp=r.filter(l=>l.price_per_sqm>0);
  const avg=wp.length?Math.round(wp.reduce((s,l)=>s+l.price_per_sqm,0)/wp.length):0;
  document.getElementById('sTotal').textContent=r.length;
  document.getElementById('sNew').textContent=n24;
  document.getElementById('sDrops').textContent=drops;
  document.getElementById('sAvg').textContent=avg?avg+'â¬':'â';

  renderCards(r);
  renderTags(cat,trans,sec,area,pMin,pMax);
                        }

// âââ TAGS âââ
function renderTags(cat,trans,sec,area,pMin,pMax){
  const t=[];
  if(cat==='res')t.push({l:'ð  ÎÎ±ÏÎ¿Î¹ÎºÎ¯Î±',c:()=>{document.getElementById('fCat').value='';apply();}});
  if(cat==='com')t.push({l:'ð¢ ÎÏÎ±Î³Î³ÎµÎ»Î¼Î±ÏÎ¹ÎºÏ',c:()=>{document.getElementById('fCat').value='';apply();}});
  if(trans)t.push({l:trans,c:()=>{document.getElementById('fTrans').value='';apply();}});
  if(sec)t.push({l:'ð '+SEC[sec].l,c:()=>{document.getElementById('fSec').value='';onSec();}});
  if(area)t.push({l:'ð '+area,c:()=>{document.getElementById('fArea').value='';apply();}});
  if(!isNaN(pMin))t.push({l:'ÎÏÏ '+fmt(pMin),c:()=>{document.getElementById('fPMin').value='';apply();}});
  if(!isNaN(pMax))t.push({l:'ÎÏÏ '+fmt(pMax),c:()=>{document.getElementById('fPMax').value='';apply();}});
  document.getElementById('tags').innerHTML=t.map((x,i)=>`<span class="active-tag">${x.l} <span class="x" onclick="event.stopPropagation();_c[${i}]()">â</span></span>`).join('');
  window._c=t.map(x=>x.c);
}
function resetAll(){['fCat','fTrans','fSec'].forEach(id=>document.getElementById(id).value='');const a=document.getElementById('fArea');a.value='';a.disabled=true;a.innerHTML='<option value="">Î ÎµÏÎ¹Î¿ÏÎ®</option>';['fPMin','fPMax'].forEach(id=>document.getElementById(id).value='');document.getElementById('sortBy').value='newest';apply();}

// âââ RENDER CARDS âââ
function renderCards(results){
  document.getElementById('rCount').textContent=results.length+' Î±Î³Î³ÎµÎ»Î¯Îµ'+(results.length===1?'Î±':'Ï');
  if(!results.length){document.getElementById('list').innerHTML='<div class="empty"><div class="empty-icon">ð</div><div class="empty-text">ÎÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î±ÏÎ¿ÏÎµÎ»Î­ÏÎ¼Î±ÏÎ±</div></div>';return;}
  document.getElementById('list').innerHTML=results.slice(0,60).map(l=>{
    const em=EM[l.property_type]||'ð ';
    let bg='';
    if(l.transaction_type==='Î ÏÎ»Î·ÏÎ·')bg+='<span class="badge badge-sale">Î ÏÎ»Î·ÏÎ·</span>';
    else if(l.transaction_type==='ÎÎ½Î¿Î¹ÎºÎ¯Î±ÏÎ·')bg+='<span class="badge badge-rent">ÎÎ½Î¿Î¹ÎºÎ¯Î±ÏÎ·</span>';
    if(l.change_type==='NEW')bg+='<span class="badge badge-new">ÎÎ­Î±</span>';
    else if(l.change_type==='PRICE_DROP')bg+='<span class="badge badge-drop">ð ÎÎµÎ¯ÏÏÎ·</span>';
    else if(l.change_type==='PRICE_UP')bg+='<span class="badge badge-up">ð ÎÏÎ¾Î·ÏÎ·</span>';
    else if(l.change_type==='MODIFIED')bg+='<span class="badge badge-mod">ÎÎ½Î·Î¼Î­ÏÏÏÎ·</span>';
    let ch='';
    if(l.price_change&&l.price_change<0){const d=Math.abs(l.price_change),pv=l.price+d,pc=pv>0?((d/pv)*100).toFixed(1):'?';ch=`<div class="card-change change-down">ð â${fmt(d)} (â${pc}%) Î±ÏÏ ${fmt(pv)}</div>`;}
    else if(l.price_change&&l.price_change>0){const pv=l.price-l.price_change,pc=pv>0?((l.price_change/pv)*100).toFixed(1):'?';ch=`<div class="card-change change-up">ð +${fmt(l.price_change)} (+${pc}%) Î±ÏÏ ${fmt(pv)}</div>`;}
    const ff=[];if(l.parking==='ÎÎ±Î¹')ff.push('ð¿ï¸ Parking');if(l.elevator==='ÎÎ±Î¹')ff.push('ð ÎÏÎ±Î½ÏÎ­Ï');if(l.view==='ÎÎ±Î¹')ff.push('ð ÎÎ­Î±');if(l.build_year&&parseInt(l.build_year)>=2020)ff.push('â¨ ÎÎµÏÎ´Î¼Î·ÏÎ¿');
    const first=l.first_seen_date||l.last_seen_date,last=l.last_seen_date,showLast=first!==last;
    const fLbl=l.change_type==='NEW'?'ÎÎ½Î­Î²Î·ÎºÎµ':'Î ÏÏÏÎ· ÎµÎ¼ÏÎ¬Î½Î¹ÏÎ·';
    return`<div class="card" onclick="openD('${l.listing_id}')">
<div class="card-top"><div class="card-badges">${bg}</div><div class="card-type">${em} ${l.property_type||''}</div></div>
<div class="card-price">${l.transaction_type==='ÎÎ½Î¿Î¹ÎºÎ¯Î±ÏÎ·'&&l.price<10000?fmt(l.price)+'/Î¼Î®Î½Î±':fmtK(l.price)}</div>
${ch}
<div class="card-meta">${l.square_meters?`<span>ð ${l.square_meters}ÏÎ¼</span>`:''}${l.bedrooms?`<span>ð ${l.bedrooms}</span>`:''}${l.bathrooms?`<span>ð¿ ${l.bathrooms}</span>`:''}${l.floor?`<span>ð ${l.floor}${!isNaN(l.floor)?'Î¿Ï':''}</span>`:''}${l.price_per_sqm?`<span>ð¶ ${l.price_per_sqm}â¬/ÏÎ¼</span>`:''}</div>
<div class="card-location">ð ${l.area||''}${l.city?' Â· '+l.city:''}</div>
${ff.length?`<div class="card-features">${ff.map(f=>`<span class="feat">${f}</span>`).join('')}</div>`:''}
<div class="card-dates"><span>${fLbl}: ${timeAgo(first)}</span>${showLast?`<span>ÎÎ½Î±Î½ÎµÏÎ¸Î·ÎºÎµ: ${timeAgo(last)}</span>`:''}</div>
</div>`;}).join('');
    }

// âââ DETAIL âââ
function openD(id){
  const l=ALL.find(x=>x.listing_id===id);if(!l)return;
  const em=EM[l.property_type]||'ð ';
  const feats=[{n:'Parking',v:l.parking,i:'ð¿ï¸'},{n:'ÎÏÎ±Î½ÏÎ­Ï',v:l.elevator,i:'ð'},{n:'ÎÏÎ±Î»ÎºÏÎ½Î¹',v:l.balcony,i:'ð'},{n:'ÎÎ­Î±',v:l.view,i:'ð'}];
  let cn='';
  if(l.price_change&&l.price_change<0)cn=`<div style="display:inline-flex;margin-top:8px;padding:3px 8px;border-radius:5px;background:rgba(255,255,255,.15);color:#fff;font-size:11px;font-weight:700">ð â${fmt(Math.abs(l.price_change))}</div>`;
  else if(l.price_change&&l.price_change>0)cn=`<div style="display:inline-flex;margin-top:8px;padding:3px 8px;border-radius:5px;background:rgba(255,255,255,.15);color:#fff;font-size:11px;font-weight:700">ð +${fmt(l.price_change)}</div>`;
  document.getElementById('sheet').innerHTML=`
<div class="sheet-handle"></div>
<div class="sheet-header"><span style="font-weight:700;font-size:15px">${em} ${l.property_type||''}${l.transaction_type?' Â· '+l.transaction_type:''}</span><button class="sheet-close" onclick="closeDetail()">â</button></div>
<div class="sheet-body">
<div class="detail-hero"><div class="detail-price">${fmt(l.price)}${l.transaction_type==='ÎÎ½Î¿Î¹ÎºÎ¯Î±ÏÎ·'&&l.price<10000?'/Î¼Î®Î½Î±':''}</div><div class="detail-sub">${l.price_per_sqm?l.price_per_sqm+'â¬/Ï.Î¼.':''}</div>${cn}</div>
<div class="detail-grid"><div class="detail-cell"><div class="detail-cell-val">${l.square_meters||'â'}</div><div class="detail-cell-lbl">Ï.Î¼.</div></div><div class="detail-cell"><div class="detail-cell-val">${l.bedrooms||'â'}</div><div class="detail-cell-lbl">Î¥ÏÎ½Î¿Î´.</div></div><div class="detail-cell"><div class="detail-cell-val">${l.floor||'â'}</div><div class="detail-cell-lbl">ÎÏÎ¿ÏÎ¿Ï</div></div></div>
<div class="detail-section"><div class="detail-section-title">ð Î¤Î¿ÏÎ¿Î¸ÎµÏÎ¯Î±</div><div style="font-size:14px;font-weight:600">${l.area||''}${l.city?' Â· '+l.city:''}</div></div>
<div class="detail-section"><div class="detail-section-title">Î§Î±ÏÎ±ÎºÏÎ·ÏÎ¹ÏÏÎ¹ÎºÎ¬</div><div class="detail-feat-grid">${feats.map(f=>`<div class="detail-feat ${f.v==='ÎÎ±Î¹'?'yes':''}">${f.i} ${f.n}: ${f.v==='ÎÎ±Î¹'?'ÎÎ±Î¹':'ÎÏÎ¹'}</div>`).join('')}${l.build_year?`<div class="detail-feat yes">ð ÎÏÎ¿Ï: ${l.build_year}</div>`:''}${l.bathrooms?`<div class="detail-feat yes">ð¿ ÎÏÎ¬Î½Î¹Î±: ${l.bathrooms}</div>`:''}</div></div>
<div class="detail-dates">ð ÎÎ½Î­Î²Î·ÎºÎµ: ${fmtDate(l.first_seen_date||l.last_seen_date)}<br>ð ÎÎ½Î·Î¼Î­ÏÏÏÎ·: ${fmtDate(l.last_seen_date)}<br>ð ÎÎ±ÏÎ¬ÏÏÎ±ÏÎ·: ${l.change_type==='NEW'?'ÎÎ­Î± Î±Î³Î³ÎµÎ»Î¯Î±':l.change_type==='PRICE_DROP'?'ÎÎµÎ¯ÏÏÎ· ÏÎ¹Î¼Î®Ï':l.change_type==='PRICE_UP'?'ÎÏÎ¾Î·ÏÎ· ÏÎ¹Î¼Î®Ï':'ÎÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ'}</div>
<a class="btn-link" href="https://www.spitogatos.gr/aggelia/${l.listing_id}" target="_blank">ð ÎÎµÏ ÏÏÎ¿ Spitogatos â</a>
</div>`;
  document.getElementById('overlay').classList.add('open');
}
function closeDetail(){document.getElementById('overlay').classList.remove('open');}

// âââ INIT âââ
load();
</script>
</body>
</html>
